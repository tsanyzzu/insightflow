import streamlit as st
import requests
import os
import json
from dotenv import load_dotenv

# CONFIGURATION 

load_dotenv()
CRYPTO_WEBHOOK = os.getenv("N8N_CRYPTO_WEBHOOK_URL")

st.set_page_config(page_title="InsightFlow Crypto", page_icon="ü™ô", layout="wide") 

# CSS Styling for Metrics 
st.markdown("""
<style>
    .stMetric {
        background-color: #1E1E1E;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #333;
    }
</style>
""", unsafe_allow_html=True)

# BACKEND FUNCTION 
def call_n8n(action_input):
    """
    Fungsi fleksibel untuk memanggil n8n.
    - Jika input string (misal: 'quant'), otomatis dibungkus jadi {"action": "quant"}
    - Jika input dict (misal: {"action": "deep_dive", "query": "..."}), dikirim langsung.
    """
    # Cek Tipe Data 
    if isinstance(action_input, dict):
        payload = action_input  
    else:
        payload = {"action": action_input} 
    try:
        response = requests.post(CRYPTO_WEBHOOK, json=payload)
        
        if response.status_code == 200:
            return response.json()
        else:
            return {"error": f"Status: {response.status_code}"}
    except Exception as e:
        return {"error": f"Connection Error: {str(e)}"}

st.title("ü™ô InsightFlow: Crypto Intelligence")
# Navigasi Tab
tab1, tab2, tab3 = st.tabs(["0Ô∏è‚É£ Quant Scan (Context)", "2Ô∏è‚É£ Narrative Radar (Trends)", "3Ô∏è‚É£ Deep Dive Analyzer"])

    # TAB 1: Quant Scan 
with tab1:
    st.markdown("### Pre-Market Alignment")
    if st.button("üîÑ Scan Market Regime", key="btn_quant"):
        with st.spinner("Connecting to Bloomberg Terminal..."):
            data = call_n8n("quant") 
        
        if "error" in data:
            st.error(data['error'])
        else:
                    col1, col2, col3 = st.columns(3)
        
        with col1:
            st.metric("Market Regime", data.get('regime', 'Unknown'))
        
        with col2:
            sent_label = data.get('sentiment_label',"-")
            sent_val = data.get('sentiment_score')
            delta_color = "normal"
            if "Greed" in sent_label: delta_color = "inverse" 
            
            st.metric("Sentiment (Fear & Greed)", f"{sent_val}/100", sent_label)

        with col3:
            st.metric("BTC Dominance Trend", data.get('btc_dominance_trend', '-'))

        # Analisis Naratif Singkat
        with st.container(border=True):
            st.markdown("### üìù Analyst Insight")
            st.write(data.get('analysis_summary', 'No analysis available.'))
            st.caption("Generated by InsightFlow Crypto Engine (Llama 3.3)")

# TAB 2: Narrative Radar 
with tab2:
    st.markdown("### üì° Narrative & Trend Intelligence")
    st.caption("Mendeteksi narasi sebelum terefleksi pada harga (Phase 2 Workflow).")
    
    if st.button("SEARCH NARRATIVES üïµÔ∏è", key="btn_narrative"):
        with st.spinner("Scraping social signals & news..."):
            data = call_n8n("narrative") 
            
        if "error" in data:
            st.error(data['error'])
        else:
            # Summary Section
            st.success(data.get('summary_insight', 'Scan Complete'))
            
            # Narrative Cards Loop
            narratives = data.get('narratives', [])
            
            if not narratives:
                st.warning("No specific narratives detected.")
            else:
                # Membuat Grid Layout
                cols = st.columns(3)
                for idx, item in enumerate(narratives):
                    with cols[idx % 3]: 
                        with st.container(border=True):
                            st.subheader(item.get('name', 'Unknown'))
                            
                            velocity = item.get('velocity', '-')
                            if "Exploding" in velocity: st.markdown("üî• **Exploding**")
                            elif "Rising" in velocity: st.markdown("üìà **Rising**")
                            else: st.markdown(f"‚û°Ô∏è {velocity}")
                            
                            st.progress(90 if 'Hype' in item.get('maturity','') else 40)
                            st.caption(f"Phase: {item.get('maturity', '-')}")
                            st.write(item.get('insight', '-'))
# TAB 3: DEEP DIVE (FUNDAMENTAL + TOKENOMICS) 
with tab3:
    st.markdown("### üîç Fundamental & Risk Audit")
    st.caption("Analisis menyeluruh: Produk, Model Bisnis, dan Risiko Suplai (Tokenomics).")

    coin_query = st.text_input("Masukkan nama proyek/koin:", placeholder="Contoh: Optimism, Arbitrum, Worldcoin...")

    if st.button("START AUDIT üß™", key="btn_deep_dive"):
        if not coin_query:
            st.warning("Mohon isi nama proyek.")
        else:
            with st.spinner(f"Melakukan bedah fundamental & tokenomics untuk {coin_query}..."):
                payload = {"action": "deep_dive", "query": coin_query}
                data = call_n8n(payload)
                
                if "error" in data:
                    st.error(data['error'])
                else:
                    # HEADER & VERDICT SECTION
                    project_name = data.get('project_name', coin_query)
                    st.subheader(f"üìë Laporan Audit: {project_name}")
    
                    m1, m2, m3 = st.columns(3)
                    
                    # Skor Fundamental
                    score = data.get('score', 0)
                    m1.metric("Fundamental Score", f"{score}/10")
                    
                    # Risk Level 
                    risk_lvl = data.get('risk_level', 'Unknown')
                    risk_color = "normal"
                    if "High" in risk_lvl or "Extreme" in risk_lvl: risk_color = "inverse"
                    m2.metric("Supply Risk Level", risk_lvl, delta_color=risk_color)
                    
                    # Verdict Singkat
                    m3.info(f"**Verdict:** {data.get('verdict', '-')}")

                    st.progress(score / 10)
                    st.divider()

                    # TOKENOMICS INTELLIGENCE SECTION
                    st.markdown("#### üîì Tokenomics & Supply Analysis")
                    
                    # Mengambil data nested tokenomics
                    tokenomics = data.get('tokenomics_audit', {})
                    
                    # Grid untuk Tokenomics
                    t1, t2, t3 = st.columns(3)
                    with t1:
                        with st.container(border=True):
                            st.caption("üìâ Inflation / Emission")
                            st.write(tokenomics.get('inflation_status', '-'))
                    with t2:
                        with st.container(border=True):
                            st.caption("üîê Unlock Schedule")
                            unlock_info = tokenomics.get('unlock_warning', '-')
                            if "Bahaya" in unlock_info or "besar" in unlock_info.lower():
                                st.error(unlock_info)
                            else:
                                st.write(unlock_info)
                    with t3:
                        with st.container(border=True):
                            st.caption("üí∞ FDV vs Market Cap")
                            st.write(tokenomics.get('fdv_analysis', '-'))

                    st.divider()

                    # PROS & CONS SECTION  
                    c1, c2 = st.columns(2)
                    with c1:
                        st.success("‚úÖ **Kekuatan (Fundamental)**")
                        for pro in data.get('pros', []):
                            st.write(f"- {pro}")

                    with c2:
                        st.error("‚ö†Ô∏è **Risiko (Product & Supply)**")
                        for con in data.get('cons', []):
                            st.write(f"- {con}")
                    
                    st.divider()

                    # --- SECTION 4: SCENARIO MODELING (PHASE 6) ---
                    st.markdown("#### üéØ Investment Scenario Matrix (6-12 Months)")
                    st.caption("Proyeksi berbasis volatilitas dan fundamental (Bukan nasihat keuangan).")

                    scenarios = data.get('scenario_analysis', {})
                    
                    # Mengambil data case
                    bull = scenarios.get('bull_case', {})
                    base = scenarios.get('base_case', {})
                    bear = scenarios.get('bear_case', {})

                    # Tampilan Kolom
                    s1, s2, s3 = st.columns(3)

                    # BULL CASE (Hijau)
                    with s1:
                        st.success("üöÄ Bull Case (Optimistic)")
                        st.metric("Target", bull.get('target', '-'))
                        st.write(f"**Syarat:** {bull.get('condition', '-')}")

                    # BASE CASE (Abu-abu/Biru)
                    with s2:
                        st.info("‚öñÔ∏è Base Case (Realistic)")
                        st.metric("Target", base.get('target', '-'))
                        st.write(f"**Syarat:** {base.get('condition', '-')}")

                    # BEAR CASE (Merah)
                    with s3:
                        st.error("üêª Bear Case (Pessimistic)")
                        st.metric("Target", bear.get('target', '-'))
                        st.write(f"**Syarat:** {bear.get('condition', '-')}")

                        

# SIDEBAR for development phase info 
with st.sidebar:
    st.info("Current Phase: **Phase 3 - Deep Dive Analyzer**")
    st.markdown("""
    **Workflow Status:**
    - Phase 0: Market Context
    - Phase 1: Capital Rotation
    - Phase 2: Narrative Radar
    - Phase 3: Deep Dive Analyzer
    - ‚è≥ Phase 4 Tokenomics Integration  
    """)
